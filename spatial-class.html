<!DOCTYPE html>
<html >

<head>

  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>Geocomputation with R</title>
  <meta name="description" content="Geocomputation with R">
  <meta name="generator" content="bookdown 0.4 and GitBook 2.6.7">

  <meta property="og:title" content="Geocomputation with R" />
  <meta property="og:type" content="book" />
  <meta property="og:url" content="http://robinlovelace.net/geocompr" />
  
  
  <meta name="github-repo" content="Robinlovelace/geocompr" />

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Geocomputation with R" />
  
  
  

<meta name="author" content="Robin Lovelace">
<meta name="author" content="Jakub Nowosad">


<meta name="date" content="2017-06-03">

  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  
  
<link rel="prev" href="intro.html">
<link rel="next" href="spatial-data-operations.html">
<script src="libs/jquery-2.2.3/jquery.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />







<script src="libs/htmlwidgets-0.8/htmlwidgets.js"></script>
<link href="libs/leaflet-0.7.7/leaflet.css" rel="stylesheet" />
<script src="libs/leaflet-0.7.7/leaflet.js"></script>
<link href="libs/leafletfix-1.0.0/leafletfix.css" rel="stylesheet" />
<link href="libs/leaflet-label-0.2.2/leaflet.label.css" rel="stylesheet" />
<script src="libs/leaflet-label-0.2.2/leaflet.label.js"></script>
<script src="libs/Proj4Leaflet-0.7.2/proj4-compressed.js"></script>
<script src="libs/Proj4Leaflet-0.7.2/proj4leaflet.js"></script>
<script src="libs/leaflet-binding-1.1.0/leaflet.js"></script>
<script src="libs/leaflet-providers-1.0.27/leaflet-providers.js"></script>
<script src="libs/leaflet-providers-plugin-1.1.0/leaflet-providers-plugin.js"></script>
<link href="libs/leaflet-awesomemarkers-2.0.3/leaflet.awesome-markers.css" rel="stylesheet" />
<script src="libs/leaflet-awesomemarkers-2.0.3/leaflet.awesome-markers.min.js"></script>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-99618359-1', 'auto');
  ga('send', 'pageview');

</script>


<style type="text/css">
div.sourceCode { overflow-x: auto; }
table.sourceCode, tr.sourceCode, td.lineNumbers, td.sourceCode {
  margin: 0; padding: 0; vertical-align: baseline; border: none; }
table.sourceCode { width: 100%; line-height: 100%; }
td.lineNumbers { text-align: right; padding-right: 4px; padding-left: 4px; color: #aaaaaa; border-right: 1px solid #aaaaaa; }
td.sourceCode { padding-left: 5px; }
code > span.kw { color: #007020; font-weight: bold; } /* Keyword */
code > span.dt { color: #902000; } /* DataType */
code > span.dv { color: #40a070; } /* DecVal */
code > span.bn { color: #40a070; } /* BaseN */
code > span.fl { color: #40a070; } /* Float */
code > span.ch { color: #4070a0; } /* Char */
code > span.st { color: #4070a0; } /* String */
code > span.co { color: #60a0b0; font-style: italic; } /* Comment */
code > span.ot { color: #007020; } /* Other */
code > span.al { color: #ff0000; font-weight: bold; } /* Alert */
code > span.fu { color: #06287e; } /* Function */
code > span.er { color: #ff0000; font-weight: bold; } /* Error */
code > span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
code > span.cn { color: #880000; } /* Constant */
code > span.sc { color: #4070a0; } /* SpecialChar */
code > span.vs { color: #4070a0; } /* VerbatimString */
code > span.ss { color: #bb6688; } /* SpecialString */
code > span.im { } /* Import */
code > span.va { color: #19177c; } /* Variable */
code > span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code > span.op { color: #666666; } /* Operator */
code > span.bu { } /* BuiltIn */
code > span.ex { } /* Extension */
code > span.pp { color: #bc7a00; } /* Preprocessor */
code > span.at { color: #7d9029; } /* Attribute */
code > span.do { color: #ba2121; font-style: italic; } /* Documentation */
code > span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code > span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code > span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
</style>

<link rel="stylesheet" href="css/style.css" type="text/css" />
<link rel="stylesheet" href="style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="./">Geocomputation with R</a></li>

<li class="divider"></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i>Welcome</a><ul>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#development"><i class="fa fa-check"></i>Development</a></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#reproducibility"><i class="fa fa-check"></i>Reproducibility</a></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#acknowledgements"><i class="fa fa-check"></i>Acknowledgements</a></li>
</ul></li>
<li class="chapter" data-level="1" data-path="intro.html"><a href="intro.html"><i class="fa fa-check"></i><b>1</b> Introduction</a><ul>
<li class="chapter" data-level="1.1" data-path="intro.html"><a href="intro.html#why-geocomputation-with-r"><i class="fa fa-check"></i><b>1.1</b> Why Geocomputation with R?</a></li>
<li class="chapter" data-level="1.2" data-path="intro.html"><a href="intro.html#rs-spatial-ecosystem"><i class="fa fa-check"></i><b>1.2</b> R’s spatial ecosystem</a></li>
</ul></li>
<li class="chapter" data-level="2" data-path="spatial-class.html"><a href="spatial-class.html"><i class="fa fa-check"></i><b>2</b> Simple features and plots</a><ul>
<li class="chapter" data-level="" data-path="spatial-class.html"><a href="spatial-class.html#prerequisites"><i class="fa fa-check"></i>Prerequisites</a></li>
<li class="chapter" data-level="2.1" data-path="spatial-class.html"><a href="spatial-class.html#an-introduction-to-simple-features"><i class="fa fa-check"></i><b>2.1</b> An introduction to Simple Features</a><ul>
<li class="chapter" data-level="2.1.1" data-path="spatial-class.html"><a href="spatial-class.html#exercises"><i class="fa fa-check"></i><b>2.1.1</b> Exercises</a></li>
</ul></li>
<li class="chapter" data-level="2.2" data-path="spatial-class.html"><a href="spatial-class.html#why-simple-features"><i class="fa fa-check"></i><b>2.2</b> Why Simple Features?</a></li>
<li class="chapter" data-level="2.3" data-path="spatial-class.html"><a href="spatial-class.html#basic-map"><i class="fa fa-check"></i><b>2.3</b> Basic map making</a><ul>
<li class="chapter" data-level="2.3.1" data-path="spatial-class.html"><a href="spatial-class.html#challenge"><i class="fa fa-check"></i><b>2.3.1</b> Challenge</a></li>
<li class="chapter" data-level="2.3.2" data-path="spatial-class.html"><a href="spatial-class.html#further-work"><i class="fa fa-check"></i><b>2.3.2</b> Further work</a></li>
<li class="chapter" data-level="2.3.3" data-path="spatial-class.html"><a href="spatial-class.html#exercises-1"><i class="fa fa-check"></i><b>2.3.3</b> Exercises</a></li>
</ul></li>
<li class="chapter" data-level="2.4" data-path="spatial-class.html"><a href="spatial-class.html#vector-data"><i class="fa fa-check"></i><b>2.4</b> Vector data</a></li>
<li class="chapter" data-level="2.5" data-path="spatial-class.html"><a href="spatial-class.html#raster-data"><i class="fa fa-check"></i><b>2.5</b> Raster data</a></li>
<li class="chapter" data-level="" data-path="spatial-class.html"><a href="spatial-class.html#prerequisites-1"><i class="fa fa-check"></i>Prerequisites</a></li>
<li class="chapter" data-level="2.6" data-path="spatial-class.html"><a href="spatial-class.html#introduction"><i class="fa fa-check"></i><b>2.6</b> Introduction</a></li>
<li class="chapter" data-level="2.7" data-path="spatial-class.html"><a href="spatial-class.html#base-vs-data.table-vs-dplyr"><i class="fa fa-check"></i><b>2.7</b> Base vs data.table vs dplyr</a></li>
<li class="chapter" data-level="2.8" data-path="spatial-class.html"><a href="spatial-class.html#attribute-subsetting"><i class="fa fa-check"></i><b>2.8</b> Attribute subsetting</a><ul>
<li class="chapter" data-level="2.8.1" data-path="spatial-class.html"><a href="spatial-class.html#exercises-2"><i class="fa fa-check"></i><b>2.8.1</b> Exercises</a></li>
</ul></li>
<li class="chapter" data-level="2.9" data-path="spatial-class.html"><a href="spatial-class.html#attribute-data-aggregation"><i class="fa fa-check"></i><b>2.9</b> Attribute data aggregation</a><ul>
<li class="chapter" data-level="2.9.1" data-path="spatial-class.html"><a href="spatial-class.html#exercises-3"><i class="fa fa-check"></i><b>2.9.1</b> Exercises</a></li>
</ul></li>
<li class="chapter" data-level="2.10" data-path="spatial-class.html"><a href="spatial-class.html#attribute-data-joining"><i class="fa fa-check"></i><b>2.10</b> Attribute data joining</a><ul>
<li class="chapter" data-level="2.10.1" data-path="spatial-class.html"><a href="spatial-class.html#left-joins"><i class="fa fa-check"></i><b>2.10.1</b> Left joins</a></li>
<li class="chapter" data-level="2.10.2" data-path="spatial-class.html"><a href="spatial-class.html#right-joins"><i class="fa fa-check"></i><b>2.10.2</b> Right joins</a></li>
<li class="chapter" data-level="2.10.3" data-path="spatial-class.html"><a href="spatial-class.html#inner-joins"><i class="fa fa-check"></i><b>2.10.3</b> Inner joins</a></li>
<li class="chapter" data-level="2.10.4" data-path="spatial-class.html"><a href="spatial-class.html#full-joins"><i class="fa fa-check"></i><b>2.10.4</b> Full joins</a></li>
<li class="chapter" data-level="2.10.5" data-path="spatial-class.html"><a href="spatial-class.html#semi-joins"><i class="fa fa-check"></i><b>2.10.5</b> Semi joins</a></li>
<li class="chapter" data-level="2.10.6" data-path="spatial-class.html"><a href="spatial-class.html#anti-joins"><i class="fa fa-check"></i><b>2.10.6</b> Anti joins</a></li>
<li class="chapter" data-level="2.10.7" data-path="spatial-class.html"><a href="spatial-class.html#exercises-4"><i class="fa fa-check"></i><b>2.10.7</b> Exercises</a></li>
</ul></li>
<li class="chapter" data-level="2.11" data-path="spatial-class.html"><a href="spatial-class.html#attribute-data-creation"><i class="fa fa-check"></i><b>2.11</b> Attribute data creation</a><ul>
<li class="chapter" data-level="2.11.1" data-path="spatial-class.html"><a href="spatial-class.html#exercises-5"><i class="fa fa-check"></i><b>2.11.1</b> Exercises</a></li>
</ul></li>
<li class="chapter" data-level="2.12" data-path="spatial-class.html"><a href="spatial-class.html#removing-spatial-information"><i class="fa fa-check"></i><b>2.12</b> Removing spatial information</a></li>
</ul></li>
<li class="chapter" data-level="3" data-path="spatial-data-operations.html"><a href="spatial-data-operations.html"><i class="fa fa-check"></i><b>3</b> Spatial data operations</a><ul>
<li class="chapter" data-level="" data-path="spatial-data-operations.html"><a href="spatial-data-operations.html#prerequisites-2"><i class="fa fa-check"></i>Prerequisites</a></li>
<li class="chapter" data-level="3.1" data-path="spatial-data-operations.html"><a href="spatial-data-operations.html#introduction-1"><i class="fa fa-check"></i><b>3.1</b> Introduction</a></li>
<li class="chapter" data-level="3.2" data-path="spatial-data-operations.html"><a href="spatial-data-operations.html#spatial-subsetting"><i class="fa fa-check"></i><b>3.2</b> Spatial subsetting</a><ul>
<li class="chapter" data-level="3.2.1" data-path="spatial-data-operations.html"><a href="spatial-data-operations.html#spatial-clipping"><i class="fa fa-check"></i><b>3.2.1</b> Spatial clipping</a></li>
</ul></li>
<li class="chapter" data-level="3.3" data-path="spatial-data-operations.html"><a href="spatial-data-operations.html#spatial-data-aggregation"><i class="fa fa-check"></i><b>3.3</b> Spatial data aggregation</a></li>
<li class="chapter" data-level="3.4" data-path="spatial-data-operations.html"><a href="spatial-data-operations.html#spatial-data-joining"><i class="fa fa-check"></i><b>3.4</b> Spatial data joining</a></li>
<li class="chapter" data-level="3.5" data-path="spatial-data-operations.html"><a href="spatial-data-operations.html#spatial-data-creation"><i class="fa fa-check"></i><b>3.5</b> Spatial data creation</a></li>
</ul></li>
<li class="chapter" data-level="4" data-path="read-write.html"><a href="read-write.html"><i class="fa fa-check"></i><b>4</b> Geographic data I/O</a><ul>
<li class="chapter" data-level="4.1" data-path="read-write.html"><a href="read-write.html#data-input-i"><i class="fa fa-check"></i><b>4.1</b> Data Input (I)</a></li>
<li class="chapter" data-level="4.2" data-path="read-write.html"><a href="read-write.html#data-output-o"><i class="fa fa-check"></i><b>4.2</b> Data output (O)</a></li>
<li class="chapter" data-level="4.3" data-path="read-write.html"><a href="read-write.html#file-formats"><i class="fa fa-check"></i><b>4.3</b> File formats</a></li>
<li class="chapter" data-level="4.4" data-path="read-write.html"><a href="read-write.html#visual-outputs"><i class="fa fa-check"></i><b>4.4</b> Visual outputs</a></li>
<li class="chapter" data-level="4.5" data-path="read-write.html"><a href="read-write.html#exercises-6"><i class="fa fa-check"></i><b>4.5</b> Exercises</a></li>
</ul></li>
<li class="chapter" data-level="5" data-path="references.html"><a href="references.html"><i class="fa fa-check"></i><b>5</b> References</a></li>
<li class="divider"></li>
<li><a href="http://robinlovelace.net/">Robin Lovelace</a></li>
<li><a href="https://nowosad.github.io/">Jakub Nowosad</a></li>

</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Geocomputation with R</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="spatial-class" class="section level1">
<h1><span class="header-section-number">2</span> Simple features and plots</h1>
<div id="prerequisites" class="section level2 unnumbered">
<h2>Prerequisites</h2>
<!--
- classes and methods in R
-->
</div>
<div id="an-introduction-to-simple-features" class="section level2">
<h2><span class="header-section-number">2.1</span> An introduction to Simple Features</h2>
<p>Simple Features is an open standard data model developed and endorsed by the Open Geospatial Consortium (<a href="http://portal.opengeospatial.org/files/?artifact_id=25355">OGC</a>) to describe how features with geographical and non-geographical features should be represented. It is a hierarchical data model that simplifies geographic data by condensing the complex range of possible geographic forms (e.g., line, point, polygon, multipolygon forms) into a single geometry class.</p>
<!-- (Figure \@ref(fig:sf-ogc)). -->
<!-- ```{r sf-ogc, fig.cap="The Simple Features class hierarchy, used with permission (on condition of linking to the source) from the Open Geospatial Consortium's document 06-103r4 (see http://www.opengeospatial.org/standards/sfa)", out.width="100%", echo=FALSE} -->
<!-- knitr::include_graphics("figures/simple-feature-class-hierarchy.png") -->
<!-- ``` -->
<p>The R implementation of Simple Features is provided by the <strong>sf</strong> package <span class="citation">(E. Pebesma <a href="#ref-R-sf">2017</a>)</span>, which can be installed with the following command:<a href="#fn2" class="footnoteRef" id="fnref2"><sup>2</sup></a></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">install.packages</span>(<span class="st">&quot;sf&quot;</span>)</code></pre></div>
<p><strong>sf</strong> incorporates the functionality of the 3 main packages of the <strong>sp</strong> paradigm (<strong>sp</strong> <span class="citation">(E. Pebesma and Bivand <a href="#ref-R-sp">2016</a>)</span> for the class system, <strong>rgdal</strong> <span class="citation">(Bivand, Keitt, and Rowlingson <a href="#ref-R-rgdal">2017</a>)</span> for reading and writing data, <strong>rgeos</strong> <span class="citation">(Bivand and Rundel <a href="#ref-R-rgeos">2017</a>)</span> for spatial operations undertaken by GEOS) in a single, cohesive whole. This is well-documented in <strong>sf</strong>’s <a href="http://cran.rstudio.com/package=sf">vignettes</a>:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">vignette</span>(<span class="st">&quot;sf1&quot;</span>) <span class="co"># for an introduction to the package</span>
<span class="kw">vignette</span>(<span class="st">&quot;sf2&quot;</span>) <span class="co"># for reading, writing and converting Simple Features</span>
<span class="kw">vignette</span>(<span class="st">&quot;sf3&quot;</span>) <span class="co"># for manipulating Simple Features</span></code></pre></div>
<p>As the first vignette explains, simple feature objects in R are stored in a data frame, with geographic data occupying special column, a ‘list-column’. This column is usually named ‘geom’ or ‘geometry’. Let’s see how simple features in R work, with reference to world boundary data from the <strong>spData</strong> package:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(spData)
<span class="kw">class</span>(world)</code></pre></div>
<p>In the above code <strong>spData</strong> silently loaded the <code>world</code> dataset (and many other spatial datasets - see <a href="https://github.com/Nowosad/spData">nowosad/spData</a> for a full list). The function <code>class()</code> tells us that the object is simultaneously of class <code>data.frame</code> and <code>sf</code>, central to the concept of simple features. Thus the object behaves in the same way as a <code>data.frame</code>, but it contains a special column called <code>geom</code>. This can be seen as the final column name of <code>world</code>:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">names</span>(world)
<span class="co">#&gt;  [1] &quot;iso_a2&quot;    &quot;name_long&quot; &quot;continent&quot; &quot;region_un&quot; &quot;subregion&quot;</span>
<span class="co">#&gt;  [6] &quot;type&quot;      &quot;area_km2&quot;  &quot;pop&quot;       &quot;lifeExp&quot;   &quot;gdpPercap&quot;</span>
<span class="co">#&gt; [11] &quot;geom&quot;</span></code></pre></div>
<p>It is the contents of this modest-looking <code>geom</code> column, gives <code>sf</code> objects their spatial powers. It’s actually a list-column, containing all the coordinates needed to plot the result as a map using the <code>plot()</code> method, the results of which are presented in Figure <a href="spatial-class.html#fig:world-all">2.1</a>.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(sf) <span class="co"># must be loaded to plot sf objects</span>
<span class="co">#&gt; Linking to GEOS 3.5.0, GDAL 2.1.0, proj.4 4.8.0</span>
<span class="kw">plot</span>(world)
<span class="co">#&gt; Warning: plotting the first 9 out of 10 attributes; use max.plot = 10 to</span>
<span class="co">#&gt; plot all</span></code></pre></div>
<div class="figure" style="text-align: center"><span id="fig:world-all"></span>
<img src="figures/world-all-1.png" alt="A spatial plot of the world using the sf package, with a facet for each attribute." width="576" />
<p class="caption">
Figure 2.1: A spatial plot of the world using the sf package, with a facet for each attribute.
</p>
</div>
<p>Note that instead of creating a single map, as most GIS programs would, the <code>plot()</code> command has created multiple maps, one for each variable in the <code>world</code> datasets. This behavior can be useful for exploring the spatial distribution of different variables and is discussed further in @(basic-map) below.</p>
<p>Being able to treat spatial objects as regular data frames with spatial powers has many advantages, especially if you are already used to working with data frames. We explore such ‘attribute operations’ in Chapter <a href="#attr"><strong>??</strong></a>. First, it’s worth taking a look at the basic behavior and contents of this simple feature object, which can usefully be thought of as a ’<strong>S</strong>patial data<strong>F</strong>rame).</p>
<p><code>sf</code> objects are easy to subset. The code below shows its first 2 rows and 3 columns. The output shows 2 major differences compared with a regular <code>data.frame</code>: the inclusion of additional geographic data (<code>geometry type</code>, <code>dimension</code>, <code>bbox</code> and CRS information - <code>epsg (SRID)</code>, <code>proj4string</code>), and the presence of final <code>geometry</code> column:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">world[<span class="dv">1</span>:<span class="dv">2</span>, <span class="dv">1</span>:<span class="dv">3</span>]
<span class="co">#&gt; Simple feature collection with 2 features and 3 fields</span>
<span class="co">#&gt; geometry type:  MULTIPOLYGON</span>
<span class="co">#&gt; dimension:      XY</span>
<span class="co">#&gt; bbox:           xmin: 11.6401 ymin: -17.93064 xmax: 75.15803 ymax: 38.48628</span>
<span class="co">#&gt; epsg (SRID):    4326</span>
<span class="co">#&gt; proj4string:    +proj=longlat +datum=WGS84 +no_defs</span>
<span class="co">#&gt;   iso_a2   name_long continent                           geom</span>
<span class="co">#&gt; 1     AF Afghanistan      Asia MULTIPOLYGON(((61.210817091...</span>
<span class="co">#&gt; 2     AO      Angola    Africa MULTIPOLYGON(((16.326528354...</span></code></pre></div>
<p>All this may seem rather complex, especially for a class system that is supposed to be simple. However, there are good reasons for organizing things this way and using <strong>sf</strong>.</p>
<div id="exercises" class="section level3">
<h3><span class="header-section-number">2.1.1</span> Exercises</h3>
<p>What does the summary of the <code>geometry</code> column tell us about the <code>world</code> dataset, in terms of:</p>
<ul>
<li>The geometry type?</li>
<li>How many countries there are?</li>
<li>The coordinate reference system (CRS)?</li>
</ul>
</div>
</div>
<div id="why-simple-features" class="section level2">
<h2><span class="header-section-number">2.2</span> Why Simple Features?</h2>
<p>There are many advantages of <strong>sf</strong> over <strong>sp</strong>, including:</p>
<ul>
<li>Faster reading and writing of data (more than 10 times faster in some cases)</li>
<li>Better plotting performance</li>
<li><strong>sf</strong> objects can be treated as dataframes in most operations</li>
<li><strong>sf</strong> functions can be combined using <code>%&gt;%</code> operator and works well with the <a href="http://tidyverse.org/">tidyverse</a> collection of R packages</li>
<li><strong>sf</strong> function names are relatively consistent and intuitive (all begin with <code>st_</code>) compared with the function names and syntax of the <strong>sp</strong>, <strong>rgdal</strong> and <strong>rgeos</strong> packages that it supersedes.</li>
</ul>
<p>A broader advantage is that simple features are so well supported by other software products, not least PostGIS, which has heavily influenced the design of <strong>sf</strong>.</p>
<p>A disadvantage you should be aware of, however, is that <strong>sf</strong> is not <em>feature complete</em> and that it continues to evolve. The transition from <strong>sp</strong> to <strong>sf</strong> will likely take many years, and many spatial packages may never switch. Even if you discover spatial data with R through the <strong>sf</strong> package, it is still worth at least being aware of <strong>sp</strong> classes, even if you rarely use them for everyday geospatial tasks.</p>
<p>Fortunately it is easy to translate between <strong>sp</strong> and <strong>sf</strong> using the <code>as()</code> function:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(sp)
world_sp =<span class="st"> </span><span class="kw">as</span>(<span class="dt">object =</span> world, <span class="dt">Class =</span> <span class="st">&quot;Spatial&quot;</span>)</code></pre></div>
</div>
<div id="basic-map" class="section level2">
<h2><span class="header-section-number">2.3</span> Basic map making</h2>
<p>Basic maps in <strong>sf</strong> can be created quickly with the base <code>plot()</code> function. Unlike <strong>sp</strong>, however, <strong>sf</strong> by default creates a faceted plot, one sub-plot for each variable, as illustrated in the left-hand image in Figure <a href="spatial-class.html#fig:sfplot">2.2</a>.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">plot</span>(world[<span class="dv">3</span>:<span class="dv">4</span>])
<span class="kw">plot</span>(world[<span class="st">&quot;pop&quot;</span>])</code></pre></div>
<div class="figure" style="text-align: center"><span id="fig:sfplot"></span>
<img src="figures/sfplot-1.png" alt="Plotting with sf, with multiple variables (left) and a single variable (right)." width="49%" /><img src="figures/sfplot-2.png" alt="Plotting with sf, with multiple variables (left) and a single variable (right)." width="49%" />
<p class="caption">
Figure 2.2: Plotting with sf, with multiple variables (left) and a single variable (right).
</p>
</div>
<p>As with <strong>sp</strong>, you can add layers to your maps created with <code>plot()</code>, with the argument <code>add = TRUE</code>.<a href="#fn3" class="footnoteRef" id="fnref3"><sup>3</sup></a> To illustrate this, and prepare for content covered in chapters <a href="#attr"><strong>??</strong></a> and <a href="spatial-data-operations.html#spatial-data-operations">3</a> on attribute and spatial data operations, we will subset and combine countries in the <code>world</code> object, to create a single object that represents Asia:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">asia =<span class="st"> </span>world[world$continent ==<span class="st"> &quot;Asia&quot;</span>, ]
asia =<span class="st"> </span><span class="kw">st_union</span>(asia)</code></pre></div>
<p>We can now plot the Asian continent over a map of the world. Note, however, that this only works if the initial plot has only 1 layer:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">plot</span>(world[<span class="st">&quot;pop&quot;</span>])
<span class="kw">plot</span>(asia, <span class="dt">add =</span> <span class="ot">TRUE</span>, <span class="dt">col =</span> <span class="st">&quot;red&quot;</span>)</code></pre></div>
<p><img src="figures/asia-1.png" width="50%" style="display: block; margin: auto;" /></p>
<p>This can be very useful for quickly checking the geographic correspondence between two or more layers: the <code>plot()</code> function is fast to execute and requires few lines of code, but does not create interactive maps with a wide range of options. For more advanced map making we recommend using a dedicated visualisation package such as <strong>tmap</strong>, <strong>ggplot2</strong>, <strong>mapview</strong>, or <strong>leaflet</strong>. <!-- TODO: cross reference advanced mapping chapter --></p>
<!-- 
- plot() function 
- map export 
-->
<div id="challenge" class="section level3">
<h3><span class="header-section-number">2.3.1</span> Challenge</h3>
<p>Using <strong>sf</strong>’s <code>plot()</code> command, create a map of Nigeria in context, like the one presented in figure <a href="spatial-class.html#fig:nigeria">2.3</a>.</p>
<ul>
<li>Hint: this used the <code>lwd</code>, <code>main</code> and <code>col</code> arguments of <code>plot()</code>.</li>
<li>Bonus: make the country boundaries a dotted grey line.</li>
<li>Hint: <code>border</code> is an additional argument of <code>plot()</code> for <strong>sf</strong> objects.</li>
</ul>
<div class="figure" style="text-align: center"><span id="fig:nigeria"></span>
<img src="figures/nigeria-1.png" alt="Map of Nigeria in context illustrating sf's plotting capabilities" width="576" />
<p class="caption">
Figure 2.3: Map of Nigeria in context illustrating sf’s plotting capabilities
</p>
</div>
</div>
<div id="further-work" class="section level3">
<h3><span class="header-section-number">2.3.2</span> Further work</h3>
<p><strong>sf</strong> makes R data objects more closely aligned to the data model used in GDAL and GEOS, in theory making spatial data operations faster. The work here provides a taster of the way that <strong>sf</strong> operates but there is much more to learn (see Chapter <a href="spatial-data-operations.html#spatial-data-operations">3</a>). There is a wealth of information that is available in the package’s vignettes: these are highly recommended.</p>
<p>As a final exercise, we’ll see how to do a spatial overlay in <strong>sf</strong> by first converting the countries of the world into centroids and then subsetting those in Asia. Because <strong>sf</strong>’s <code>plot()</code> builds on the base <code>plot()</code> function, you have access to all the base plotting options developed for base plotting. If you are accustomed to base plotting, this will be useful, as illustrated by the variable circle sizes generated by the <code>cex</code> argument in Figure <a href="spatial-class.html#fig:africa">2.4</a>, which was generated using the code below.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">world_centroids =<span class="st"> </span><span class="kw">st_centroid</span>(world)
<span class="kw">plot</span>(world[<span class="st">&quot;continent&quot;</span>])
<span class="kw">plot</span>(world_centroids, <span class="dt">add =</span> <span class="ot">TRUE</span>, <span class="dt">cex =</span> world$pop /<span class="st"> </span><span class="fl">1e8</span>, <span class="dt">lwd =</span> <span class="dv">3</span>)</code></pre></div>
<div class="figure" style="text-align: center"><span id="fig:africa"></span>
<img src="figures/africa-1.png" alt="Centroids representing country population, diameter being proportional to population." width="50%" />
<p class="caption">
Figure 2.4: Centroids representing country population, diameter being proportional to population.
</p>
</div>
<p>Note: another way of acheiving the same result is with a GEOS function for identifying spatial overlay, which we’ll cover in more datail in Chapter <a href="spatial-data-operations.html#spatial-data-operations">3</a>.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">sel_asia =<span class="st"> </span><span class="kw">st_intersects</span>(world_centroids, asia, <span class="dt">sparse =</span> <span class="ot">FALSE</span>)
<span class="co">#&gt; although coordinates are longitude/latitude, it is assumed that they are planar</span>
<span class="kw">summary</span>(sel_asia)
<span class="co">#&gt;      V1         </span>
<span class="co">#&gt;  Mode :logical  </span>
<span class="co">#&gt;  FALSE:134      </span>
<span class="co">#&gt;  TRUE :43</span></code></pre></div>
<!-- More appropriate for subsequent chapters. -->
<!-- This shows that there are 43 countries in Asia -->
<!-- We can check if they are the same countries as follows: -->
<!-- ```{r} -->
<!-- africa_centroids2 = world_centroids[sel_africa,] -->
<!-- identical(africa_centroids, africa_centroids2) -->
<!-- ``` -->
</div>
<div id="exercises-1" class="section level3">
<h3><span class="header-section-number">2.3.3</span> Exercises</h3>
<ul>
<li>What does the <code>lwd</code> argument do in the <code>plot()</code> code that generates Figure <a href="spatial-class.html#fig:africa">2.4</a>.</li>
<li>Perform the same operations and map making for another continent of your choice.</li>
<li>Bonus: Download some global geographic data and add attribute variables assigning them to the continents of the world.</li>
</ul>
</div>
</div>
<div id="vector-data" class="section level2">
<h2><span class="header-section-number">2.4</span> Vector data</h2>
<!-- 
sf data types:
- POINT
- LINESTRING
- POLYGON
- MULTIPOINT
- MULTILINESTRING
- MULTIPOLYGON
- GEOMETRYCOLLECTION
- CIRCULARSTRING
- COMPOUNDCURVE
- CURVEPOLYGON
- MULTICURVE
- MULTISURFACE
- CURVE
- SURFACE
- POLYHEDRALSURFACE
- TIN
- TRIANGLE

- what's sf, sfc, sfg
- methods(class = "sf")

-->
</div>
<div id="raster-data" class="section level2">
<h2><span class="header-section-number">2.5</span> Raster data</h2>
<!-- 
- raster data types 
- RasterLayer
- RasterStack
- RasterBrick
-->

</div>
<div id="prerequisites-1" class="section level2 unnumbered">
<h2>Prerequisites</h2>
<ul>
<li>This chapter requires <strong>tidyverse</strong> and <strong>sf</strong>:</li>
</ul>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(sf)
<span class="kw">library</span>(tidyverse)</code></pre></div>
<ul>
<li>You must have loaded the <code>world</code> and <code>worldbank_df</code> data from the <strong>spData</strong> package:</li>
</ul>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(spData)
<span class="kw">data</span>(<span class="st">&quot;world&quot;</span>)
<span class="kw">data</span>(<span class="st">&quot;worldbank_df&quot;</span>)</code></pre></div>
</div>
<div id="introduction" class="section level2">
<h2><span class="header-section-number">2.6</span> Introduction</h2>
<p>Attribute data is non-geographic information associated with geographical data. In the context of simple features, introduced in the previous chapter, this means a tabular data joined onto the <code>geometry</code> variables of <code>sf</code> objects. This structure enables multiple columns to represent a range of attributes for thousands of features (one row per feature).</p>
<p>There is a strong overlap between geographical and non-geographical operations: non-spatial subset, aggregate and join operations each have their geographical equivalents. For this reason this chapter provides the foundation for next (chapter <a href="spatial-data-operations.html#spatial-data-operations">3</a>). The two chapters share the same structure and input data; it is recommended that they are read together.</p>
<p>The non-spatial versions of these methods are common and easy to understand with R, so they are covered first. The methods are largely cross-transferable to the trickier tasks of spatial data operations, so pay attention!</p>
<p>Simple features are represented as objects, such as <code>world</code>, with class <code>sf</code> in the <strong>sf</strong> package:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">class</span>(world)
<span class="co">#&gt; [1] &quot;sf&quot;         &quot;data.frame&quot;</span></code></pre></div>
<p>The output shows that <code>sf</code> objects have two classes (<code>sf</code> and <code>data.frame</code>), meaning that are essentially data frames. Using data frames, the basic class used for data analysis in R, particularly within <a href="http://tidyverse.org/">the <strong>tidyverse</strong> package ecosystem</a>, has many advantages when it comes to attribute data operations. It means that all the accumulated know-how in the R community for handling data frames to be applied to geographic data which contain attributes.</p>
<p>This ‘world’ dataset contains 10 non-geographical variables (and one geometry column) with data for almost 200 countries, as can be ascertained using base functions for working with tabular data:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">dim</span>(world) <span class="co"># it is a 2 dimensional object, with rows and columns</span>
<span class="co">#&gt; [1] 177  11</span>
<span class="kw">nrow</span>(world) <span class="co"># how many rows?</span>
<span class="co">#&gt; [1] 177</span>
<span class="kw">ncol</span>(world) <span class="co"># how many columns?</span>
<span class="co">#&gt; [1] 11</span></code></pre></div>
<p>Extracting the attribute data of an <code>sf</code> object is the same as removing the geometry column:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">world_df =<span class="st"> </span>world
<span class="kw">st_geometry</span>(world_df) =<span class="st"> </span><span class="ot">NULL</span>
<span class="kw">class</span>(world_df)
<span class="co">#&gt; [1] &quot;data.frame&quot;</span></code></pre></div>
<p>This can be useful if the geometry column causes problem, e.g. by occupying large amounts of RAM. However, for most cases there is no harm in keeping the geometry column, as data frame operations on <code>sf</code> will only act on the attribute data. For this reason, being good at working with attribute data in geographic data is the same being proficient at handling data frames in R. For many applications, the most effective and intuitive way to work with data frames is with the <strong>dplyr</strong> package.</p>
</div>
<div id="base-vs-data.table-vs-dplyr" class="section level2">
<h2><span class="header-section-number">2.7</span> Base vs data.table vs dplyr</h2>
<p>Simple feature objects of class <code>sf</code> behave exactly the same as <code>data.frame</code> objects for most base R operations. Unlike objects of class <code>Spatial</code> defined by the <strong>sp</strong> package, <code>sf</code> objects are also compatible with <strong>dplyr</strong> and <strong>data.table</strong> packages. This is an advantage because they provide fast functions for data manipulation.</p>
<p>Which method you use is largely a matter of preference. In this chapter the focus is largely on <strong>dplyr</strong> because of it’s intuitive function names and its ability to perform multiple chained operations using the pipe operator. The important thing is that you select a data processing paradigm of choice, and master it.</p>
</div>
<div id="attribute-subsetting" class="section level2">
<h2><span class="header-section-number">2.8</span> Attribute subsetting</h2>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">world[<span class="dv">1</span>:<span class="dv">6</span>, ] <span class="co"># subset rows</span></code></pre></div>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">world[, <span class="dv">1</span>:<span class="dv">3</span>] <span class="co"># subset columns</span></code></pre></div>
<p>After each operation, the geometry column is preserved.</p>
<p><strong>dplyr</strong> makes working with data frames easier and is compatible with <code>sf</code> objects, after the package has been loaded:</p>
<p>The <code>select()</code> function, for example, can be used to both subset and renames columns in a single line, for example:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">world1 =<span class="st"> </span><span class="kw">select</span>(world, name_long, continent, <span class="dt">population =</span> pop)
<span class="kw">head</span>(world1, <span class="dt">n =</span> <span class="dv">2</span>)
<span class="co">#&gt; Simple feature collection with 2 features and 3 fields</span>
<span class="co">#&gt; geometry type:  MULTIPOLYGON</span>
<span class="co">#&gt; dimension:      XY</span>
<span class="co">#&gt; bbox:           xmin: 11.6401 ymin: -17.93064 xmax: 75.15803 ymax: 38.48628</span>
<span class="co">#&gt; epsg (SRID):    4326</span>
<span class="co">#&gt; proj4string:    +proj=longlat +datum=WGS84 +no_defs</span>
<span class="co">#&gt;     name_long continent population                           geom</span>
<span class="co">#&gt; 1 Afghanistan      Asia   31627506 MULTIPOLYGON(((61.210817091...</span>
<span class="co">#&gt; 2      Angola    Africa   24227524 MULTIPOLYGON(((16.326528354...</span></code></pre></div>
<p>This is more concise than the base R equivalent (which saves the result as an object called <code>world2</code> to avoid overriding the <code>world</code> dataset created previously):</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">world2 =<span class="st"> </span>world[<span class="kw">c</span>(<span class="st">&quot;name_long&quot;</span>, <span class="st">&quot;continent&quot;</span>, <span class="st">&quot;pop&quot;</span>)] <span class="co"># subset columns by name</span>
<span class="kw">names</span>(world2)[<span class="dv">3</span>] =<span class="st"> &quot;population&quot;</span> <span class="co"># rename column manually</span></code></pre></div>
<p>The <em>pipe</em> operator (<code>%&gt;%</code>), which passes the output of one function into the first argument of the next function, is commonly used in <strong>dplyr</strong> data analysis workflows. This works because the fundamental <strong>dplyr</strong> functions (or ‘verbs’, like <code>select()</code>) all take a data frame object in and spit a data frame object out. Combining many functions together with pipes is called <em>chaining</em> or <em>piping</em>. The advantage over base R for complex data processing operations is that this approach prevents nested functions and is easy to read because there is a clear order and modularity to the work (a piped command can be commented out, for example).</p>
<p>The example below shows yet another way of creating the renamed <code>world</code> dataset, using the pipe operator:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">world3 =<span class="st"> </span>world %&gt;%
<span class="st">  </span><span class="kw">select</span>(name_long, continent)</code></pre></div>
<p>Note that this can also be written without the pipe operator because, in the above code, the <code>world</code> object is simply ‘piped’ into the first argument of <code>select()</code>. The equivalent <strong>dplyr</strong> code without the pipe operator is:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">world4 =<span class="st"> </span><span class="kw">select</span>(world, name_long, continent)</code></pre></div>
<p>The pipe operator can be used for many data processing tasks with attribute data:</p>
<!-- todo - describe these: ==, !=, >, >=, <, <=, &, | -->
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Filtering attribute data with dplyr</span>
world %&gt;%
<span class="st">  </span><span class="kw">filter</span>(pop &gt;<span class="st"> </span><span class="fl">1e9</span>)
<span class="co">#&gt; Simple feature collection with 2 features and 10 fields</span>
<span class="co">#&gt; geometry type:  MULTIPOLYGON</span>
<span class="co">#&gt; dimension:      XY</span>
<span class="co">#&gt; bbox:           xmin: -180 ymin: -90 xmax: 180 ymax: 83.64513</span>
<span class="co">#&gt; epsg (SRID):    4326</span>
<span class="co">#&gt; proj4string:    +proj=longlat +datum=WGS84 +no_defs</span>
<span class="co">#&gt;   iso_a2 name_long continent region_un     subregion              type</span>
<span class="co">#&gt; 1     CN     China      Asia      Asia  Eastern Asia           Country</span>
<span class="co">#&gt; 2     IN     India      Asia      Asia Southern Asia Sovereign country</span>
<span class="co">#&gt;   area_km2      pop lifeExp gdpPercap                           geom</span>
<span class="co">#&gt; 1  9409832 1.36e+09    75.8     12759 MULTIPOLYGON(((110.33918786...</span>
<span class="co">#&gt; 2  3142892 1.30e+09    68.0      5392 MULTIPOLYGON(((77.837450799...</span></code></pre></div>
<p>This is equivalent to the following base R code (not run to preserve the NAs):<a href="#fn4" class="footnoteRef" id="fnref4"><sup>4</sup></a></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># subsetting simple feature rows by values</span>
world$pop[<span class="kw">is.na</span>(world$pop)] =<span class="st"> </span><span class="dv">0</span> <span class="co"># set NAs to 0</span>
world_few_rows =<span class="st"> </span>world[world$pop &gt;<span class="st"> </span><span class="fl">1e9</span>,]</code></pre></div>
<div id="exercises-2" class="section level3">
<h3><span class="header-section-number">2.8.1</span> Exercises</h3>
</div>
</div>
<div id="attribute-data-aggregation" class="section level2">
<h2><span class="header-section-number">2.9</span> Attribute data aggregation</h2>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># data summary (not shown)</span>
<span class="kw">summary</span>(world)

<span class="co"># data summary by groups (not shown)</span>
world_continents =<span class="st"> </span>world %&gt;%<span class="st"> </span>
<span class="st">  </span><span class="kw">group_by</span>(continent) %&gt;%<span class="st"> </span>
<span class="st">  </span><span class="kw">summarise</span>(<span class="dt">pop =</span> <span class="kw">sum</span>(pop, <span class="dt">na.rm =</span> <span class="ot">TRUE</span>), <span class="dt">country_n =</span> <span class="kw">n</span>())
world_continents</code></pre></div>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># sort variables</span>
## by name
world_continents %&gt;%<span class="st"> </span>
<span class="st">  </span><span class="kw">arrange</span>(continent)
<span class="co">#&gt; Simple feature collection with 8 features and 3 fields</span>
<span class="co">#&gt; geometry type:  GEOMETRY</span>
<span class="co">#&gt; dimension:      XY</span>
<span class="co">#&gt; bbox:           xmin: -180 ymin: -90 xmax: 180 ymax: 83.64513</span>
<span class="co">#&gt; epsg (SRID):    4326</span>
<span class="co">#&gt; proj4string:    +proj=longlat +datum=WGS84 +no_defs</span>
<span class="co">#&gt; # A tibble: 8 x 4</span>
<span class="co">#&gt;    continent      pop country_n              geom</span>
<span class="co">#&gt;        &lt;chr&gt;    &lt;dbl&gt;     &lt;int&gt;  &lt;simple_feature&gt;</span>
<span class="co">#&gt; 1     Africa 1.15e+09        51 &lt;MULTIPOLYGON...&gt;</span>
<span class="co">#&gt; 2 Antarctica 0.00e+00         1 &lt;MULTIPOLYGON...&gt;</span>
<span class="co">#&gt; 3       Asia 4.31e+09        47 &lt;MULTIPOLYGON...&gt;</span>
<span class="co">#&gt; 4     Europe 7.39e+08        39 &lt;MULTIPOLYGON...&gt;</span>
<span class="co">#&gt; # ... with 4 more rows</span>
## by population (in descending order)
world_continents %&gt;%<span class="st"> </span>
<span class="st">  </span><span class="kw">arrange</span>(-pop)
<span class="co">#&gt; Simple feature collection with 8 features and 3 fields</span>
<span class="co">#&gt; geometry type:  GEOMETRY</span>
<span class="co">#&gt; dimension:      XY</span>
<span class="co">#&gt; bbox:           xmin: -180 ymin: -90 xmax: 180 ymax: 83.64513</span>
<span class="co">#&gt; epsg (SRID):    4326</span>
<span class="co">#&gt; proj4string:    +proj=longlat +datum=WGS84 +no_defs</span>
<span class="co">#&gt; # A tibble: 8 x 4</span>
<span class="co">#&gt;       continent      pop country_n              geom</span>
<span class="co">#&gt;           &lt;chr&gt;    &lt;dbl&gt;     &lt;int&gt;  &lt;simple_feature&gt;</span>
<span class="co">#&gt; 1          Asia 4.31e+09        47 &lt;MULTIPOLYGON...&gt;</span>
<span class="co">#&gt; 2        Africa 1.15e+09        51 &lt;MULTIPOLYGON...&gt;</span>
<span class="co">#&gt; 3        Europe 7.39e+08        39 &lt;MULTIPOLYGON...&gt;</span>
<span class="co">#&gt; 4 North America 5.65e+08        18 &lt;MULTIPOLYGON...&gt;</span>
<span class="co">#&gt; # ... with 4 more rows</span></code></pre></div>
<div id="exercises-3" class="section level3">
<h3><span class="header-section-number">2.9.1</span> Exercises</h3>
</div>
</div>
<div id="attribute-data-joining" class="section level2">
<h2><span class="header-section-number">2.10</span> Attribute data joining</h2>
<!-- https://github.com/dgrtwo/fuzzyjoin -->
<!-- http://r4ds.had.co.nz/relational-data.html -->
<p>Combining data from different sources is one of the most common task in data preparation. It could be done using joins - methods created to work with a pair of tables. The <strong>dplyr</strong> package has a set of verbs to easily connect <code>data.frames</code> - <code>left_join()</code>, <code>right_join()</code>, <code>inner_join()</code>, <code>full_join</code>, <code>semi_join()</code> and <code>anti_join()</code>. They are thoroughly explained in the Relational data chapter in the book R for Data Science <span class="citation">(Grolemund and Wickham <a href="#ref-grolemund_r_2016">2016</a>)</span>.</p>
<p>Working with spatial data, however, usually involves a connection between spatial data (<code>sf</code> objects) with tables (<code>data.frame</code> objects). Fortunately, the <strong>sf</strong> package has all of the <strong>dplyr</strong> join functions adapted to work with <code>sf</code> objects. The only important difference between combining of two <code>data.frames</code> and combining of <code>sf</code> with <code>data.frame</code> is a <code>geom</code> column. Therefore, the result of data joins could be either an <code>sf</code> or <code>data.frame</code> object.</p>
<p>The easiest way to understand the concept of joins is to use a smaller datasets. We will use an <code>sf</code> object <code>north_america</code> with country codes (<code>iso_a2</code>), names and geometries, as well as <code>data.frame</code> object <code>wb_north_america</code> containing information about urban population and unemployment for three countries. It is important to add that the first object has data about Canada, Greenland and United States and the second one has data about Canada, Mexico and United States:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">north_america =<span class="st"> </span>world %&gt;%
<span class="st">  </span><span class="kw">filter</span>(subregion ==<span class="st"> &quot;Northern America&quot;</span>) %&gt;%
<span class="st">  </span><span class="kw">select</span>(iso_a2, name_long)

<span class="kw">plot</span>(north_america[<span class="dv">0</span>])

wb_north_america =<span class="st"> </span>worldbank_df %&gt;%<span class="st"> </span>
<span class="st">  </span><span class="kw">filter</span>(name %in%<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;Canada&quot;</span>, <span class="st">&quot;Mexico&quot;</span>, <span class="st">&quot;United States&quot;</span>)) %&gt;%
<span class="st">  </span><span class="kw">select</span>(name, iso_a2, urban_pop, <span class="dt">unemploy =</span> unemployment)</code></pre></div>
<p><img src="figures/unnamed-chunk-17-1.png" width="576" style="display: block; margin: auto;" /></p>
<div id="left-joins" class="section level3">
<h3><span class="header-section-number">2.10.1</span> Left joins</h3>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">left_join1 =<span class="st"> </span>north_america %&gt;%<span class="st"> </span>
<span class="st">  </span><span class="kw">left_join</span>(wb_north_america, <span class="dt">by =</span> <span class="st">&quot;iso_a2&quot;</span>)
left_join1
<span class="co">#&gt; Simple feature collection with 3 features and 5 fields</span>
<span class="co">#&gt; geometry type:  MULTIPOLYGON</span>
<span class="co">#&gt; dimension:      XY</span>
<span class="co">#&gt; bbox:           xmin: -171.7911 ymin: 18.91619 xmax: -12.20855 ymax: 83.64513</span>
<span class="co">#&gt; epsg (SRID):    4326</span>
<span class="co">#&gt; proj4string:    +proj=longlat +datum=WGS84 +no_defs</span>
<span class="co">#&gt;   iso_a2     name_long          name urban_pop unemploy</span>
<span class="co">#&gt; 1     CA        Canada        Canada  29022137     6.91</span>
<span class="co">#&gt; 2     GL     Greenland          &lt;NA&gt;        NA       NA</span>
<span class="co">#&gt; 3     US United States United States 259740511     6.17</span>
<span class="co">#&gt;                             geom</span>
<span class="co">#&gt; 1 MULTIPOLYGON(((-63.6645 46....</span>
<span class="co">#&gt; 2 MULTIPOLYGON(((-46.76379 82...</span>
<span class="co">#&gt; 3 MULTIPOLYGON(((-155.54211 1...</span></code></pre></div>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">left_join2 =<span class="st"> </span>north_america %&gt;%<span class="st"> </span>
<span class="st">  </span><span class="kw">left_join</span>(wb_north_america, <span class="dt">by =</span> <span class="kw">c</span>(<span class="st">&quot;name_long&quot;</span> =<span class="st"> &quot;name&quot;</span>))
left_join2
<span class="co">#&gt; Simple feature collection with 3 features and 5 fields</span>
<span class="co">#&gt; geometry type:  MULTIPOLYGON</span>
<span class="co">#&gt; dimension:      XY</span>
<span class="co">#&gt; bbox:           xmin: -171.7911 ymin: 18.91619 xmax: -12.20855 ymax: 83.64513</span>
<span class="co">#&gt; epsg (SRID):    4326</span>
<span class="co">#&gt; proj4string:    +proj=longlat +datum=WGS84 +no_defs</span>
<span class="co">#&gt;   iso_a2.x     name_long iso_a2.y urban_pop unemploy</span>
<span class="co">#&gt; 1       CA        Canada       CA  29022137     6.91</span>
<span class="co">#&gt; 2       GL     Greenland     &lt;NA&gt;        NA       NA</span>
<span class="co">#&gt; 3       US United States       US 259740511     6.17</span>
<span class="co">#&gt;                             geom</span>
<span class="co">#&gt; 1 MULTIPOLYGON(((-63.6645 46....</span>
<span class="co">#&gt; 2 MULTIPOLYGON(((-46.76379 82...</span>
<span class="co">#&gt; 3 MULTIPOLYGON(((-155.54211 1...</span></code></pre></div>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">left_join3 =<span class="st"> </span>north_america %&gt;%<span class="st"> </span>
<span class="st">  </span><span class="kw">left_join</span>(wb_north_america, <span class="dt">by =</span> <span class="kw">c</span>(<span class="st">&quot;iso_a2&quot;</span>, <span class="st">&quot;name_long&quot;</span> =<span class="st"> &quot;name&quot;</span>))
left_join3
<span class="co">#&gt; Simple feature collection with 3 features and 4 fields</span>
<span class="co">#&gt; geometry type:  MULTIPOLYGON</span>
<span class="co">#&gt; dimension:      XY</span>
<span class="co">#&gt; bbox:           xmin: -171.7911 ymin: 18.91619 xmax: -12.20855 ymax: 83.64513</span>
<span class="co">#&gt; epsg (SRID):    4326</span>
<span class="co">#&gt; proj4string:    +proj=longlat +datum=WGS84 +no_defs</span>
<span class="co">#&gt;   iso_a2     name_long urban_pop unemploy                           geom</span>
<span class="co">#&gt; 1     CA        Canada  29022137     6.91 MULTIPOLYGON(((-63.6645 46....</span>
<span class="co">#&gt; 2     GL     Greenland        NA       NA MULTIPOLYGON(((-46.76379 82...</span>
<span class="co">#&gt; 3     US United States 259740511     6.17 MULTIPOLYGON(((-155.54211 1...</span></code></pre></div>
<!-- ```{r} -->
<!-- # error: keeps geom col -->
<!-- left_join4 = wb_north_america %>%  -->
<!--   left_join(north_america, by = c("iso_a2")) -->
<!-- left_join4 -->
<!-- ``` -->
</div>
<div id="right-joins" class="section level3">
<h3><span class="header-section-number">2.10.2</span> Right joins</h3>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">right_join1 =<span class="st"> </span>north_america %&gt;%<span class="st"> </span>
<span class="st">  </span><span class="kw">right_join</span>(wb_north_america, <span class="dt">by =</span> <span class="kw">c</span>(<span class="st">&quot;iso_a2&quot;</span>, <span class="st">&quot;name_long&quot;</span> =<span class="st"> &quot;name&quot;</span>))
right_join1
<span class="co">#&gt; Simple feature collection with 3 features and 4 fields (of which 1 is empty)</span>
<span class="co">#&gt; geometry type:  GEOMETRY</span>
<span class="co">#&gt; dimension:      XY</span>
<span class="co">#&gt; bbox:           xmin: -171.7911 ymin: 18.91619 xmax: -52.6481 ymax: 83.23324</span>
<span class="co">#&gt; epsg (SRID):    4326</span>
<span class="co">#&gt; proj4string:    +proj=longlat +datum=WGS84 +no_defs</span>
<span class="co">#&gt;   iso_a2     name_long urban_pop unemploy                           geom</span>
<span class="co">#&gt; 1     CA        Canada  29022137     6.91 MULTIPOLYGON(((-63.6645 46....</span>
<span class="co">#&gt; 2     MX        Mexico  99018446     5.25           GEOMETRYCOLLECTION()</span>
<span class="co">#&gt; 3     US United States 259740511     6.17 MULTIPOLYGON(((-155.54211 1...</span></code></pre></div>
<!-- ```{r} -->
<!-- # error: unwanted geom column added -->
<!-- right_join2 = wb_north_america %>%  -->
<!--   right_join(north_america, by = "iso_a2") #%>% plot() -->
<!-- right_join2 -->
<!-- ``` -->
</div>
<div id="inner-joins" class="section level3">
<h3><span class="header-section-number">2.10.3</span> Inner joins</h3>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">inner_join1 =<span class="st"> </span>north_america %&gt;%<span class="st"> </span>
<span class="st">  </span><span class="kw">inner_join</span>(wb_north_america, <span class="dt">by =</span> <span class="st">&quot;iso_a2&quot;</span>) 
inner_join1
<span class="co">#&gt; Simple feature collection with 2 features and 5 fields</span>
<span class="co">#&gt; geometry type:  MULTIPOLYGON</span>
<span class="co">#&gt; dimension:      XY</span>
<span class="co">#&gt; bbox:           xmin: -171.7911 ymin: 18.91619 xmax: -52.6481 ymax: 83.23324</span>
<span class="co">#&gt; epsg (SRID):    4326</span>
<span class="co">#&gt; proj4string:    +proj=longlat +datum=WGS84 +no_defs</span>
<span class="co">#&gt;   iso_a2     name_long          name urban_pop unemploy</span>
<span class="co">#&gt; 1     CA        Canada        Canada  29022137     6.91</span>
<span class="co">#&gt; 2     US United States United States 259740511     6.17</span>
<span class="co">#&gt;                             geom</span>
<span class="co">#&gt; 1 MULTIPOLYGON(((-63.6645 46....</span>
<span class="co">#&gt; 2 MULTIPOLYGON(((-155.54211 1...</span></code></pre></div>
<!-- ```{r} -->
<!-- # error: geom column added -->
<!-- inner_join2 =  wb_north_america %>%  -->
<!--   inner_join(north_america, by = "iso_a2")  -->
<!-- inner_join2 -->
<!-- ``` -->
</div>
<div id="full-joins" class="section level3">
<h3><span class="header-section-number">2.10.4</span> Full joins</h3>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">full_join1 =<span class="st"> </span>north_america %&gt;%<span class="st"> </span>
<span class="st">  </span><span class="kw">full_join</span>(wb_north_america, <span class="dt">by =</span> <span class="st">&quot;iso_a2&quot;</span>)
full_join1
<span class="co">#&gt; Simple feature collection with 4 features and 5 fields (of which 1 is empty)</span>
<span class="co">#&gt; geometry type:  GEOMETRY</span>
<span class="co">#&gt; dimension:      XY</span>
<span class="co">#&gt; bbox:           xmin: -171.7911 ymin: 18.91619 xmax: -12.20855 ymax: 83.64513</span>
<span class="co">#&gt; epsg (SRID):    4326</span>
<span class="co">#&gt; proj4string:    +proj=longlat +datum=WGS84 +no_defs</span>
<span class="co">#&gt;   iso_a2     name_long          name urban_pop unemploy</span>
<span class="co">#&gt; 1     CA        Canada        Canada  29022137     6.91</span>
<span class="co">#&gt; 2     GL     Greenland          &lt;NA&gt;        NA       NA</span>
<span class="co">#&gt; 3     US United States United States 259740511     6.17</span>
<span class="co">#&gt; 4     MX          &lt;NA&gt;        Mexico  99018446     5.25</span>
<span class="co">#&gt;                             geom</span>
<span class="co">#&gt; 1 MULTIPOLYGON(((-63.6645 46....</span>
<span class="co">#&gt; 2 MULTIPOLYGON(((-46.76379 82...</span>
<span class="co">#&gt; 3 MULTIPOLYGON(((-155.54211 1...</span>
<span class="co">#&gt; 4           GEOMETRYCOLLECTION()</span></code></pre></div>
<!-- ```{r} -->
<!-- # error: null geom -->
<!-- full_join2 = wb_north_america %>%  -->
<!--   full_join(north_america, by = "iso_a2") #%>% plot() -->
<!-- full_join2 -->
<!-- ``` -->
</div>
<div id="semi-joins" class="section level3">
<h3><span class="header-section-number">2.10.5</span> Semi joins</h3>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">semi_join1 =<span class="st"> </span>north_america %&gt;%<span class="st"> </span>
<span class="st">  </span><span class="kw">semi_join</span>(wb_north_america, <span class="dt">by =</span> <span class="st">&quot;iso_a2&quot;</span>)
semi_join1
<span class="co">#&gt; Simple feature collection with 2 features and 2 fields</span>
<span class="co">#&gt; geometry type:  MULTIPOLYGON</span>
<span class="co">#&gt; dimension:      XY</span>
<span class="co">#&gt; bbox:           xmin: -171.7911 ymin: 18.91619 xmax: -52.6481 ymax: 83.23324</span>
<span class="co">#&gt; epsg (SRID):    4326</span>
<span class="co">#&gt; proj4string:    +proj=longlat +datum=WGS84 +no_defs</span>
<span class="co">#&gt;   iso_a2     name_long                           geom</span>
<span class="co">#&gt; 1     CA        Canada MULTIPOLYGON(((-63.6645 46....</span>
<span class="co">#&gt; 2     US United States MULTIPOLYGON(((-155.54211 1...</span></code></pre></div>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">semi_join2 =<span class="st"> </span>wb_north_america %&gt;%
<span class="st">  </span><span class="kw">semi_join</span>(north_america, <span class="dt">by =</span> <span class="st">&quot;iso_a2&quot;</span>)
semi_join2
<span class="co">#&gt;            name iso_a2 urban_pop unemploy</span>
<span class="co">#&gt; 1        Canada     CA  29022137     6.91</span>
<span class="co">#&gt; 2 United States     US 259740511     6.17</span></code></pre></div>
</div>
<div id="anti-joins" class="section level3">
<h3><span class="header-section-number">2.10.6</span> Anti joins</h3>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">anti_join1 =<span class="st"> </span>north_america %&gt;%<span class="st"> </span>
<span class="st">  </span><span class="kw">anti_join</span>(wb_north_america, <span class="dt">by =</span> <span class="st">&quot;iso_a2&quot;</span>)
anti_join1
<span class="co">#&gt; Simple feature collection with 1 feature and 2 fields</span>
<span class="co">#&gt; geometry type:  MULTIPOLYGON</span>
<span class="co">#&gt; dimension:      XY</span>
<span class="co">#&gt; bbox:           xmin: -73.297 ymin: 60.03676 xmax: -12.20855 ymax: 83.64513</span>
<span class="co">#&gt; epsg (SRID):    4326</span>
<span class="co">#&gt; proj4string:    +proj=longlat +datum=WGS84 +no_defs</span>
<span class="co">#&gt;   iso_a2 name_long                           geom</span>
<span class="co">#&gt; 1     GL Greenland MULTIPOLYGON(((-46.76379 82...</span></code></pre></div>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">anti_join2 =<span class="st"> </span>wb_north_america %&gt;%<span class="st"> </span>
<span class="st">  </span><span class="kw">anti_join</span>(north_america, <span class="dt">by =</span> <span class="st">&quot;iso_a2&quot;</span>)
anti_join2
<span class="co">#&gt;     name iso_a2 urban_pop unemploy</span>
<span class="co">#&gt; 1 Mexico     MX  99018446     5.25</span></code></pre></div>
</div>
<div id="exercises-4" class="section level3">
<h3><span class="header-section-number">2.10.7</span> Exercises</h3>
<!-- -->
</div>
</div>
<div id="attribute-data-creation" class="section level2">
<h2><span class="header-section-number">2.11</span> Attribute data creation</h2>
<div id="exercises-5" class="section level3">
<h3><span class="header-section-number">2.11.1</span> Exercises</h3>
</div>
</div>
<div id="removing-spatial-information" class="section level2">
<h2><span class="header-section-number">2.12</span> Removing spatial information</h2>
<p>Most of the function from <strong>sf</strong> package do not drop a <code>geometry</code> column. To extract a data frame <code>st_geometry()</code> or <code>st_set_geometry()</code> function can be used.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">world_st =<span class="st"> </span>world
<span class="kw">st_geometry</span>(world_st) =<span class="st"> </span><span class="ot">NULL</span>
<span class="kw">class</span>(world_st)
<span class="co">#&gt; [1] &quot;data.frame&quot;</span>

<span class="co"># OR</span>

world_st2 =<span class="st"> </span>world
world_st2 =<span class="st"> </span>world_st2 %&gt;%<span class="st"> </span><span class="kw">st_set_geometry</span>(<span class="ot">NULL</span>)
<span class="kw">class</span>(world_st2)
<span class="co">#&gt; [1] &quot;data.frame&quot;</span></code></pre></div>
<!-- 
- dplyr, tidyr, and purrr packages
- lubridate??
- pipes
-->

</div>
</div>
<h3> References</h3>
<div id="refs" class="references">
<div id="ref-R-sf">
<p>Pebesma, Edzer. 2017. <em>Sf: Simple Features for R</em>. <a href="https://github.com/edzer/sfr/" class="uri">https://github.com/edzer/sfr/</a>.</p>
</div>
<div id="ref-R-sp">
<p>Pebesma, Edzer, and Roger Bivand. 2016. <em>Sp: Classes and Methods for Spatial Data</em>. <a href="https://CRAN.R-project.org/package=sp" class="uri">https://CRAN.R-project.org/package=sp</a>.</p>
</div>
<div id="ref-R-rgdal">
<p>Bivand, Roger, Tim Keitt, and Barry Rowlingson. 2017. <em>Rgdal: Bindings for the Geospatial Data Abstraction Library</em>. <a href="https://CRAN.R-project.org/package=rgdal" class="uri">https://CRAN.R-project.org/package=rgdal</a>.</p>
</div>
<div id="ref-R-rgeos">
<p>Bivand, Roger, and Colin Rundel. 2017. <em>Rgeos: Interface to Geometry Engine - Open Source (GEOS)</em>. <a href="https://CRAN.R-project.org/package=rgeos" class="uri">https://CRAN.R-project.org/package=rgeos</a>.</p>
</div>
<div id="ref-grolemund_r_2016">
<p>Grolemund, Garrett, and Hadley Wickham. 2016. <em>R for Data Science</em>. 1 edition. OReilly Media.</p>
</div>
</div>
<div class="footnotes">
<hr />
<ol start="2">
<li id="fn2"><p>The development version, which may contain new features, can be installed with <code>devtools::install_github(&quot;edzer/sfr&quot;)</code><a href="spatial-class.html#fnref2">↩</a></p></li>
<li id="fn3"><p>In fact, when you <code>plot()</code> an <strong>sf</strong> object, R is calling <code>sf:::plot.sf()</code> behind the scenes. <code>plot()</code> is a generic method that behaves differently depending on the class of object being plotted.<a href="spatial-class.html#fnref3">↩</a></p></li>
<li id="fn4"><p><a href="https://github.com/Robinlovelace/geocompr/issues/28">Note</a> NAs do not work for subsetting by inequalities in base R, hence conversion of NAs to 0s in this version)<a href="spatial-class.html#fnref4">↩</a></p></li>
</ol>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="intro.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="spatial-data-operations.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/lunr.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script>
require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"google": false,
"weibo": false,
"instapper": false,
"vk": false,
"all": ["facebook", "google", "twitter", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": "https://github.com/Robinlovelace/geocompr/edit/master/02-spatial-data.Rmd",
"text": "Edit"
},
"download": null,
"toc": {
"collapse": "section"
}
});
});
</script>

</body>

</html>
